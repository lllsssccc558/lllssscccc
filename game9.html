<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML5 舞蹈革命遊戲：節奏舞者</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a0033, #330066);
            padding: 20px;
            color: #fff;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1000px;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.3);
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 0, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255, 0, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0, 255, 255, 0.1) 0%, transparent 50%);
            z-index: -1;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            color: #fff;
            margin-bottom: 5px;
            font-size: 3.2rem;
            text-shadow: 
                0 0 10px #ff00ff,
                0 0 20px #ff00ff,
                0 0 30px #ff00ff;
            letter-spacing: 2px;
            background: linear-gradient(90deg, #ff00ff, #00ffff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: glow 2s infinite alternate;
        }
        
        @keyframes glow {
            0% { filter: drop-shadow(0 0 5px #ff00ff); }
            100% { filter: drop-shadow(0 0 15px #00ffff); }
        }
        
        .subtitle {
            color: #bbbbbb;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .game-info {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 768px) {
            .game-info {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .info-box {
            background: linear-gradient(145deg, rgba(102, 0, 153, 0.5), rgba(51, 0, 102, 0.5));
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 0, 255, 0.3);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s;
        }
        
        .info-box:hover {
            transform: translateY(-5px);
        }
        
        .info-label {
            font-size: 0.9rem;
            color: #ff99ff;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .info-value {
            font-size: 2rem;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 0 0 10px currentColor;
        }
        
        .score-value {
            color: #ffff00;
        }
        
        .combo-value {
            color: #00ffff;
        }
        
        .accuracy-value {
            color: #00ff00;
        }
        
        .high-score-value {
            color: #ff9900;
        }
        
        .game-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .game-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .dance-stage {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 500px;
            background: linear-gradient(to bottom, #000033, #000011);
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid rgba(255, 0, 255, 0.5);
            box-shadow: 
                0 0 30px rgba(255, 0, 255, 0.3),
                inset 0 0 30px rgba(0, 0, 0, 0.5);
        }
        
        .arrow-lanes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
        }
        
        .arrow-lane {
            flex: 1;
            border-right: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .arrow-lane:last-child {
            border-right: none;
        }
        
        .lane-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, 
                transparent 0%, 
                rgba(255, 255, 255, 0.02) 50%, 
                transparent 100%);
            pointer-events: none;
        }
        
        .hit-line {
            position: absolute;
            bottom: 100px;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.7);
            z-index: 10;
        }
        
        .hit-line::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 0;
            width: 100%;
            height: 30px;
            background: linear-gradient(to bottom, 
                transparent, 
                rgba(255, 255, 255, 0.1), 
                transparent);
        }
        
        .control-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 600px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            border: 2px solid rgba(255, 0, 255, 0.3);
        }
        
        .arrow-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 10px;
            font-size: 2.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .arrow-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .left-btn {
            background: linear-gradient(145deg, #ff4444, #cc0000);
            color: white;
        }
        
        .down-btn {
            background: linear-gradient(145deg, #44ff44, #00cc00);
            color: white;
        }
        
        .up-btn {
            background: linear-gradient(145deg, #4444ff, #0000cc);
            color: white;
        }
        
        .right-btn {
            background: linear-gradient(145deg, #ffff44, #cccc00);
            color: white;
        }
        
        .left-btn.active {
            background: linear-gradient(145deg, #ff8888, #ff0000);
            box-shadow: 0 0 20px #ff0000;
        }
        
        .down-btn.active {
            background: linear-gradient(145deg, #88ff88, #00ff00);
            box-shadow: 0 0 20px #00ff00;
        }
        
        .up-btn.active {
            background: linear-gradient(145deg, #8888ff, #0000ff);
            box-shadow: 0 0 20px #0000ff;
        }
        
        .right-btn.active {
            background: linear-gradient(145deg, #ffff88, #ffff00);
            box-shadow: 0 0 20px #ffff00;
        }
        
        .game-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 1px solid rgba(255, 0, 255, 0.2);
            justify-content: center;
        }
        
        .song-selector, .difficulty-selector, .main-controls {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        .control-label {
            margin-bottom: 10px;
            color: #ff99ff;
            font-weight: 500;
            font-size: 1.1rem;
            text-align: center;
        }
        
        .song-buttons, .difficulty-buttons, .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .song-btn, .difficulty-btn, .control-btn {
            padding: 12px 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 1rem;
            text-align: center;
        }
        
        .song-btn {
            background: rgba(102, 0, 153, 0.5);
            color: #ffccff;
            border: 1px solid rgba(255, 0, 255, 0.3);
        }
        
        .song-btn:hover {
            background: rgba(102, 0, 153, 0.7);
        }
        
        .song-btn.active {
            background: linear-gradient(90deg, #ff00ff, #9900cc);
            color: white;
            box-shadow: 0 0 15px #ff00ff;
        }
        
        .difficulty-btn {
            background: rgba(0, 102, 153, 0.5);
            color: #ccffff;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }
        
        .difficulty-btn:hover {
            background: rgba(0, 102, 153, 0.7);
        }
        
        .difficulty-btn.active {
            background: linear-gradient(90deg, #00ffff, #0099cc);
            color: white;
            box-shadow: 0 0 15px #00ffff;
        }
        
        .control-btn {
            background: linear-gradient(90deg, #ff9900, #ff6600);
            color: white;
            font-weight: bold;
        }
        
        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 102, 0, 0.4);
        }
        
        .control-btn:active {
            transform: translateY(0);
        }
        
        .control-btn.pause {
            background: linear-gradient(90deg, #ffff00, #ffcc00);
        }
        
        .control-btn.restart {
            background: linear-gradient(90deg, #ff4444, #cc0000);
        }
        
        .combo-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            font-weight: bold;
            color: #ffff00;
            text-shadow: 
                0 0 10px #ffff00,
                0 0 20px #ffff00,
                0 0 30px #ffff00;
            opacity: 0;
            pointer-events: none;
            z-index: 100;
            transition: opacity 0.3s;
        }
        
        .judgment-display {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.5rem;
            font-weight: bold;
            opacity: 0;
            pointer-events: none;
            z-index: 50;
            transition: all 0.3s;
        }
        
        .perfect {
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
        }
        
        .great {
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }
        
        .good {
            color: #ffff00;
            text-shadow: 0 0 10px #ffff00;
        }
        
        .miss {
            color: #ff4444;
            text-shadow: 0 0 10px #ff4444;
        }
        
        .instructions {
            background: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 15px;
            margin-top: 10px;
            border: 1px solid rgba(255, 0, 255, 0.2);
        }
        
        .instructions h3 {
            margin-bottom: 15px;
            color: #ff99ff;
            border-bottom: 2px solid rgba(255, 153, 255, 0.3);
            padding-bottom: 8px;
            font-size: 1.5rem;
        }
        
        .instructions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .instruction-item {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 0, 255, 0.1);
        }
        
        .instruction-item h4 {
            color: #00ffff;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .key {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 6px;
            margin: 0 5px;
            font-family: monospace;
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-width: 40px;
            text-align: center;
            font-weight: bold;
        }
        
        .key.arrow {
            color: white;
        }
        
        .key.left {
            background: linear-gradient(145deg, #ff4444, #cc0000);
        }
        
        .key.down {
            background: linear-gradient(145deg, #44ff44, #00cc00);
        }
        
        .key.up {
            background: linear-gradient(145deg, #4444ff, #0000cc);
        }
        
        .key.right {
            background: linear-gradient(145deg, #ffff44, #cccc00);
        }
        
        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff00ff, #00ffff);
            width: 0%;
            transition: width 0.3s;
            border-radius: 5px;
        }
        
        .song-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 0 10px;
        }
        
        .song-title {
            font-size: 1.3rem;
            color: #ffffff;
            font-weight: bold;
        }
        
        .song-difficulty {
            font-size: 1.1rem;
            color: #00ffff;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }
            
            .dance-stage {
                height: 400px;
            }
            
            .arrow-btn {
                font-size: 2rem;
            }
            
            .combo-display {
                font-size: 4rem;
            }
            
            .game-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .song-selector, .difficulty-selector, .main-controls {
                width: 100%;
                max-width: 300px;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 2rem;
            }
            
            .dance-stage {
                height: 350px;
            }
            
            .info-value {
                font-size: 1.5rem;
            }
            
            .combo-display {
                font-size: 3rem;
            }
            
            .judgment-display {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>節奏舞者</h1>
            <p class="subtitle">跟著節拍舞動，挑戰你的節奏感！</p>
        </header>
        
        <div class="game-info">
            <div class="info-box">
                <div class="info-label">分數</div>
                <div class="info-value score-value" id="currentScore">0</div>
            </div>
            <div class="info-box">
                <div class="info-label">連擊</div>
                <div class="info-value combo-value" id="comboCount">0</div>
            </div>
            <div class="info-box">
                <div class="info-label">準確率</div>
                <div class="info-value accuracy-value" id="accuracy">100%</div>
            </div>
            <div class="info-box">
                <div class="info-label">最高分</div>
                <div class="info-value high-score-value" id="highScore">0</div>
            </div>
        </div>
        
        <div class="game-area">
            <div class="song-info">
                <div class="song-title" id="currentSongTitle">選擇歌曲開始遊戲</div>
                <div class="song-difficulty" id="currentDifficulty">難度: 未選擇</div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="songProgress"></div>
            </div>
            
            <div class="game-screen">
                <div class="dance-stage" id="danceStage">
                    <div class="arrow-lanes">
                        <div class="arrow-lane" data-lane="0">
                            <div class="lane-overlay"></div>
                        </div>
                        <div class="arrow-lane" data-lane="1">
                            <div class="lane-overlay"></div>
                        </div>
                        <div class="arrow-lane" data-lane="2">
                            <div class="lane-overlay"></div>
                        </div>
                        <div class="arrow-lane" data-lane="3">
                            <div class="lane-overlay"></div>
                        </div>
                    </div>
                    <div class="hit-line"></div>
                </div>
                
                <div class="control-panel">
                    <button class="arrow-btn left-btn" data-direction="left">←</button>
                    <button class="arrow-btn down-btn" data-direction="down">↓</button>
                    <button class="arrow-btn up-btn" data-direction="up">↑</button>
                    <button class="arrow-btn right-btn" data-direction="right">→</button>
                </div>
            </div>
        </div>
        
        <div class="judgment-display" id="judgmentDisplay"></div>
        <div class="combo-display" id="comboDisplay"></div>
        
        <div class="game-controls">
            <div class="song-selector">
                <div class="control-label">選擇歌曲</div>
                <div class="song-buttons">
                    <button class="song-btn active" data-song="techno">電子舞曲</button>
                    <button class="song-btn" data-song="pop">流行節奏</button>
                    <button class="song-btn" data-song="rock">搖滾狂熱</button>
                    <button class="song-btn" data-song="jazz">爵士律動</button>
                </div>
            </div>
            
            <div class="difficulty-selector">
                <div class="control-label">選擇難度</div>
                <div class="difficulty-buttons">
                    <button class="difficulty-btn active" data-difficulty="easy">簡單</button>
                    <button class="difficulty-btn" data-difficulty="normal">普通</button>
                    <button class="difficulty-btn" data-difficulty="hard">困難</button>
                    <button class="difficulty-btn" data-difficulty="expert">專家</button>
                </div>
            </div>
            
            <div class="main-controls">
                <div class="control-label">遊戲控制</div>
                <div class="control-buttons">
                    <button class="control-btn" id="startBtn">開始遊戲</button>
                    <button class="control-btn pause" id="pauseBtn" disabled>暫停</button>
                    <button class="control-btn restart" id="restartBtn">重新開始</button>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>遊戲說明與控制</h3>
            <div class="instructions-grid">
                <div class="instruction-item">
                    <h4>遊戲玩法</h4>
                    <p>箭頭從上方落下，當箭頭到達底部的擊打線時，按下對應的按鍵。</p>
                    <p>按鍵時機越準確，得分越高。</p>
                    <p>連續正確擊中會產生連擊，獲得額外分數。</p>
                    <p>錯過箭頭會中斷連擊。</p>
                </div>
                <div class="instruction-item">
                    <h4>控制方式</h4>
                    <p><span class="key arrow left">←</span> 或 <span class="key">A</span>: 左箭頭</p>
                    <p><span class="key arrow down">↓</span> 或 <span class="key">S</span>: 下箭頭</p>
                    <p><span class="key arrow up">↑</span> 或 <span class="key">W</span>: 上箭頭</p>
                    <p><span class="key arrow right">→</span> 或 <span class="key">D</span>: 右箭頭</p>
                    <p><span class="key">空格鍵</span>: 暫停/繼續遊戲</p>
                    <p><span class="key">ESC</span>: 重新開始</p>
                </div>
                <div class="instruction-item">
                    <h4>評分標準</h4>
                    <p>• <span style="color:#00ffff">完美</span>: 100分 + 準確率100%</p>
                    <p>• <span style="color:#00ff00">優秀</span>: 80分 + 準確率90%</p>
                    <p>• <span style="color:#ffff00">良好</span>: 50分 + 準確率70%</p>
                    <p>• <span style="color:#ff4444">錯過</span>: 0分 + 中斷連擊</p>
                    <p>• 連擊獎勵: 每10連擊 +10%分數</p>
                </div>
                <div class="instruction-item">
                    <h4>難度說明</h4>
                    <p>• <strong>簡單</strong>: 慢速節奏，箭頭數量少</p>
                    <p>• <strong>普通</strong>: 中等速度，標準箭頭密度</p>
                    <p>• <strong>困難</strong>: 快速節奏，高密度箭頭</p>
                    <p>• <strong>專家</strong>: 極限速度，超高密度箭頭</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>HTML5 舞蹈革命遊戲 - 使用Canvas和JavaScript實現 | 跟著節拍，舞動你的手指！</p>
    </div>

    <script>
        // 遊戲變數
        const danceStage = document.getElementById('danceStage');
        const currentScoreElement = document.getElementById('currentScore');
        const comboCountElement = document.getElementById('comboCount');
        const accuracyElement = document.getElementById('accuracy');
        const highScoreElement = document.getElementById('highScore');
        const songProgressElement = document.getElementById('songProgress');
        const currentSongTitleElement = document.getElementById('currentSongTitle');
        const currentDifficultyElement = document.getElementById('currentDifficulty');
        const judgmentDisplay = document.getElementById('judgmentDisplay');
        const comboDisplay = document.getElementById('comboDisplay');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const restartBtn = document.getElementById('restartBtn');
        const songButtons = document.querySelectorAll('.song-btn');
        const difficultyButtons = document.querySelectorAll('.difficulty-btn');
        const arrowButtons = document.querySelectorAll('.arrow-btn');
        
        // 遊戲設定
        const LANE_COUNT = 4;
        const HIT_LINE_POSITION = 400; // 擊打線位置 (從頂部算起)
        const ARROW_SPEED = 2; // 初始速度
        const JUDGMENT_WINDOW = {
            perfect: 50,   // 毫秒
            great: 100,    // 毫秒
            good: 150      // 毫秒
        };
        
        // 遊戲狀態
        let gameActive = false;
        let gamePaused = false;
        let gameOver = false;
        let score = 0;
        let combo = 0;
        let maxCombo = 0;
        let notesHit = 0;
        let notesTotal = 0;
        let accuracy = 100;
        let highScore = localStorage.getItem('ddrHighScore') || 0;
        let currentSong = 'techno';
        let currentDifficulty = 'easy';
        let songPattern = [];
        let activeNotes = [];
        let gameTime = 0;
        let songDuration = 0;
        let gameLoopId = null;
        let lastNoteTime = 0;
        let noteInterval = 1000;
        
        // 箭頭顏色和方向
        const ARROW_TYPES = [
            { direction: 'left', color: '#ff4444', symbol: '←', key: 'ArrowLeft', keyCode: 37 },
            { direction: 'down', color: '#44ff44', symbol: '↓', key: 'ArrowDown', keyCode: 40 },
            { direction: 'up', color: '#4444ff', symbol: '↑', key: 'ArrowUp', keyCode: 38 },
            { direction: 'right', color: '#ffff44', symbol: '→', key: 'ArrowRight', keyCode: 39 }
        ];
        
        // 歌曲定義
        const SONGS = {
            techno: {
                title: '電子舞曲 - Techno Beat',
                duration: 90000, // 90秒
                bpm: 130,
                pattern: [
                    [0, 1, 2, 3], // 簡單節奏
                    [0, 2, 1, 3], // 交叉節奏
                    [0, 1, 2, 3, 0, 1, 2, 3], // 快速節奏
                    [0, 0, 1, 1, 2, 2, 3, 3], // 雙擊
                    [0, 3, 1, 2, 2, 1, 3, 0], // 鏡像
                    [0, 1, 0, 1, 2, 3, 2, 3], // 模式A
                    [0, 2, 1, 3, 0, 2, 1, 3], // 模式B
                ]
            },
            pop: {
                title: '流行節奏 - Pop Rhythm',
                duration: 85000, // 85秒
                bpm: 120,
                pattern: [
                    [0, 1, 2, 3],
                    [0, 2, 1, 3],
                    [0, 0, 1, 1],
                    [2, 2, 3, 3],
                    [0, 1, 2, 3, 0, 1, 2, 3],
                    [0, 3, 1, 2],
                    [0, 1, 2, 3, 2, 1, 0, 3]
                ]
            },
            rock: {
                title: '搖滾狂熱 - Rock Fever',
                duration: 80000, // 80秒
                bpm: 140,
                pattern: [
                    [0, 1, 2, 3],
                    [0, 0, 1, 1, 2, 2, 3, 3],
                    [0, 3, 0, 3, 1, 2, 1, 2],
                    [0, 1, 0, 1, 2, 3, 2, 3],
                    [0, 2, 1, 3, 0, 2, 1, 3],
                    [0, 1, 2, 3, 3, 2, 1, 0],
                    [0, 0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3]
                ]
            },
            jazz: {
                title: '爵士律動 - Jazz Flow',
                duration: 95000, // 95秒
                bpm: 110,
                pattern: [
                    [0, 2, 1, 3],
                    [0, 1, 2, 3],
                    [0, 3, 2, 1],
                    [0, 1, 0, 2, 1, 3, 2, 3],
                    [0, 2, 1, 2, 3, 1, 0, 3],
                    [0, 0, 2, 2, 1, 1, 3, 3],
                    [0, 3, 1, 2, 0, 3, 1, 2]
                ]
            }
        };
        
        // 難度設定
        const DIFFICULTY_SETTINGS = {
            easy: {
                speed: 1.5,
                noteDensity: 0.5,
                patternLength: 4,
                scoreMultiplier: 1.0
            },
            normal: {
                speed: 2.0,
                noteDensity: 0.7,
                patternLength: 6,
                scoreMultiplier: 1.2
            },
            hard: {
                speed: 2.5,
                noteDensity: 0.85,
                patternLength: 8,
                scoreMultiplier: 1.5
            },
            expert: {
                speed: 3.0,
                noteDensity: 1.0,
                patternLength: 10,
                scoreMultiplier: 2.0
            }
        };
        
        // 更新最高分顯示
        highScoreElement.textContent = highScore;
        
        // 生成歌曲節奏模式
        function generateSongPattern() {
            const song = SONGS[currentSong];
            const difficulty = DIFFICULTY_SETTINGS[currentDifficulty];
            const pattern = [];
            
            // 計算總節拍數
            const totalBeats = Math.floor(song.duration / (60000 / song.bpm));
            
            // 根據難度決定每個節拍生成箭頭的機率
            for (let beat = 0; beat < totalBeats; beat++) {
                // 每4拍選擇一個模式
                const patternIndex = beat % song.pattern.length;
                const basePattern = song.pattern[patternIndex];
                
                // 隨機決定是否生成箭頭（根據密度）
                if (Math.random() < difficulty.noteDensity) {
                    // 從基本模式中選擇一個箭頭
                    const laneIndex = basePattern[Math.floor(Math.random() * basePattern.length)];
                    pattern.push({
                        beat: beat,
                        lane: laneIndex,
                        time: beat * (60000 / song.bpm) // 轉換為毫秒
                    });
                }
            }
            
            // 添加一些特殊模式
            addSpecialPatterns(pattern, totalBeats, difficulty);
            
            return pattern.sort((a, b) => a.time - b.time);
        }
        
        // 添加特殊模式
        function addSpecialPatterns(pattern, totalBeats, difficulty) {
            // 添加一些連續箭頭
            for (let i = 0; i < totalBeats; i += 16) {
                if (Math.random() < 0.7) {
                    const startBeat = i + Math.floor(Math.random() * 8);
                    const length = 4 + Math.floor(Math.random() * 4);
                    
                    for (let j = 0; j < length; j++) {
                        const lane = Math.floor(Math.random() * LANE_COUNT);
                        pattern.push({
                            beat: startBeat + j,
                            lane: lane,
                            time: (startBeat + j) * (60000 / SONGS[currentSong].bpm)
                        });
                    }
                }
            }
            
            // 添加同時按下的箭頭（和弦）
            for (let i = 0; i < totalBeats; i += 24) {
                if (Math.random() < 0.5) {
                    const beat = i + Math.floor(Math.random() * 12);
                    // 2-4個同時按下的箭頭
                    const chordSize = 2 + Math.floor(Math.random() * 3);
                    const lanes = new Set();
                    
                    while (lanes.size < chordSize) {
                        lanes.add(Math.floor(Math.random() * LANE_COUNT));
                    }
                    
                    lanes.forEach(lane => {
                        pattern.push({
                            beat: beat,
                            lane: lane,
                            time: beat * (60000 / SONGS[currentSong].bpm)
                        });
                    });
                }
            }
        }
        
        // 創建箭頭元素
        function createArrowElement(lane, time) {
            const arrow = document.createElement('div');
            arrow.className = 'arrow';
            arrow.dataset.lane = lane;
            arrow.dataset.time = time;
            
            const arrowType = ARROW_TYPES[lane];
            arrow.innerHTML = arrowType.symbol;
            arrow.style.cssText = `
                position: absolute;
                top: -60px;
                left: 50%;
                transform: translateX(-50%);
                width: 50px;
                height: 50px;
                background: ${arrowType.color};
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 28px;
                font-weight: bold;
                color: white;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
                z-index: 5;
                transition: transform 0.1s;
                border: 2px solid white;
            `;
            
            return arrow;
        }
        
        // 更新箭頭位置
        function updateArrows() {
            if (!gameActive || gamePaused) return;
            
            const currentTime = Date.now() - gameTime;
            const speed = DIFFICULTY_SETTINGS[currentDifficulty].speed;
            
            // 檢查是否需要生成新箭頭
            if (songPattern.length > 0) {
                const nextNote = songPattern[0];
                if (nextNote.time <= currentTime) {
                    // 生成新箭頭
                    const arrowElement = createArrowElement(nextNote.lane, nextNote.time);
                    const laneElement = document.querySelector(`[data-lane="${nextNote.lane}"]`);
                    laneElement.appendChild(arrowElement);
                    
                    activeNotes.push({
                        element: arrowElement,
                        lane: nextNote.lane,
                        spawnTime: nextNote.time,
                        hit: false
                    });
                    
                    songPattern.shift();
                    notesTotal++;
                }
            }
            
            // 更新現有箭頭位置
            for (let i = activeNotes.length - 1; i >= 0; i--) {
                const note = activeNotes[i];
                const timeAlive = currentTime - note.spawnTime;
                const position = HIT_LINE_POSITION + timeAlive * speed / 10;
                
                note.element.style.top = `${position}px`;
                
                // 檢查箭頭是否超過擊打線（錯過）
                if (position > HIT_LINE_POSITION + 100 && !note.hit) {
                    // 錯過箭頭
                    showJudgment('miss', note.lane);
                    removeNote(i);
                    resetCombo();
                } else if (position > danceStage.clientHeight) {
                    // 箭頭離開屏幕
                    removeNote(i);
                }
            }
            
            // 更新歌曲進度
            updateSongProgress(currentTime);
        }
        
        // 移除箭頭
        function removeNote(index) {
            const note = activeNotes[index];
            if (note.element.parentNode) {
                note.element.parentNode.removeChild(note.element);
            }
            activeNotes.splice(index, 1);
        }
        
        // 處理箭頭擊中
        function hitArrow(lane) {
            if (!gameActive || gamePaused) return;
            
            const currentTime = Date.now() - gameTime;
            let hitNoteIndex = -1;
            let bestTimeDiff = Infinity;
            
            // 尋找最接近擊打線的對應箭頭
            for (let i = 0; i < activeNotes.length; i++) {
                const note = activeNotes[i];
                if (note.lane === lane && !note.hit) {
                    const timeDiff = Math.abs(currentTime - note.spawnTime);
                    const position = HIT_LINE_POSITION + (currentTime - note.spawnTime) * DIFFICULTY_SETTINGS[currentDifficulty].speed / 10;
                    
                    // 檢查是否在擊打範圍內
                    if (Math.abs(position - HIT_LINE_POSITION) <= 100) {
                        if (timeDiff < bestTimeDiff) {
                            bestTimeDiff = timeDiff;
                            hitNoteIndex = i;
                        }
                    }
                }
            }
            
            if (hitNoteIndex !== -1) {
                const note = activeNotes[hitNoteIndex];
                const timeDiff = Math.abs(currentTime - note.spawnTime);
                let judgment = '';
                let points = 0;
                
                // 判斷擊中精度
                if (timeDiff <= JUDGMENT_WINDOW.perfect) {
                    judgment = 'perfect';
                    points = 100;
                } else if (timeDiff <= JUDGMENT_WINDOW.great) {
                    judgment = 'great';
                    points = 80;
                } else if (timeDiff <= JUDGMENT_WINDOW.good) {
                    judgment = 'good';
                    points = 50;
                } else {
                    judgment = 'miss';
                    points = 0;
                }
                
                if (judgment !== 'miss') {
                    // 成功擊中
                    note.hit = true;
                    note.element.style.transform = 'translateX(-50%) scale(1.3)';
                    note.element.style.opacity = '0.7';
                    
                    // 添加擊中效果
                    setTimeout(() => {
                        if (note.element.parentNode) {
                            note.element.parentNode.removeChild(note.element);
                        }
                    }, 100);
                    
                    // 移除箭頭
                    activeNotes.splice(hitNoteIndex, 1);
                    
                    // 更新分數和連擊
                    updateScore(points, judgment);
                    notesHit++;
                    
                    // 顯示判斷結果
                    showJudgment(judgment, lane);
                } else {
                    // 錯過
                    showJudgment('miss', lane);
                    resetCombo();
                    removeNote(hitNoteIndex);
                }
                
                // 更新準確率
                updateAccuracy();
                
                return true;
            }
            
            return false;
        }
        
        // 更新分數
        function updateScore(points, judgment) {
            // 應用難度倍率
            const multiplier = DIFFICULTY_SETTINGS[currentDifficulty].scoreMultiplier;
            const basePoints = Math.round(points * multiplier);
            
            // 連擊加成
            const comboBonus = Math.floor(combo / 10) * 0.1; // 每10連擊增加10%
            const totalPoints = Math.round(basePoints * (1 + comboBonus));
            
            score += totalPoints;
            currentScoreElement.textContent = score;
            
            // 更新連擊
            combo++;
            comboCountElement.textContent = combo;
            
            if (combo > maxCombo) {
                maxCombo = combo;
            }
            
            // 顯示連擊特效
            if (combo % 10 === 0 && combo > 0) {
                showComboEffect();
            }
        }
        
        // 重置連擊
        function resetCombo() {
            combo = 0;
            comboCountElement.textContent = combo;
        }
        
        // 更新準確率
        function updateAccuracy() {
            if (notesTotal > 0) {
                accuracy = Math.round((notesHit / notesTotal) * 10000) / 100;
                accuracyElement.textContent = `${accuracy}%`;
            }
        }
        
        // 顯示判斷結果
        function showJudgment(judgment, lane) {
            judgmentDisplay.textContent = getJudgmentText(judgment);
            judgmentDisplay.className = `judgment-display ${judgment}`;
            judgmentDisplay.style.opacity = '1';
            judgmentDisplay.style.transform = `translateX(-50%) translateY(0)`;
            
            // 根據箭頭位置調整顯示位置
            const laneWidth = danceStage.clientWidth / LANE_COUNT;
            const laneCenter = lane * laneWidth + laneWidth / 2;
            judgmentDisplay.style.left = `${laneCenter}px`;
            
            // 動畫效果
            setTimeout(() => {
                judgmentDisplay.style.opacity = '0';
                judgmentDisplay.style.transform = `translateX(-50%) translateY(-20px)`;
            }, 500);
        }
        
        // 顯示連擊特效
        function showComboEffect() {
            comboDisplay.textContent = `${combo} COMBO!`;
            comboDisplay.style.opacity = '1';
            comboDisplay.style.transform = 'translate(-50%, -50%) scale(1)';
            
            // 動畫效果
            setTimeout(() => {
                comboDisplay.style.opacity = '0';
                comboDisplay.style.transform = 'translate(-50%, -50%) scale(0.5)';
            }, 1000);
        }
        
        // 獲取判斷文字
        function getJudgmentText(judgment) {
            switch(judgment) {
                case 'perfect': return '完美!';
                case 'great': return '優秀!';
                case 'good': return '良好';
                case 'miss': return '錯過...';
                default: return '';
            }
        }
        
        // 更新歌曲進度
        function updateSongProgress(currentTime) {
            const song = SONGS[currentSong];
            const progress = Math.min(100, (currentTime / song.duration) * 100);
            songProgressElement.style.width = `${progress}%`;
            
            // 檢查歌曲是否結束
            if (currentTime >= song.duration) {
                endGame();
            }
        }
        
        // 開始遊戲
        function startGame() {
            if (gameActive && !gamePaused) return;
            
            // 如果遊戲已結束或未開始，重置遊戲
            if (gameOver || !gameActive) {
                resetGameState();
            }
            
            gameActive = true;
            gamePaused = false;
            gameOver = false;
            
            startBtn.textContent = '重新開始';
            pauseBtn.disabled = false;
            pauseBtn.textContent = '暫停';
            
            // 生成歌曲節奏
            songPattern = generateSongPattern();
            
            // 更新顯示
            currentSongTitleElement.textContent = SONGS[currentSong].title;
            currentDifficultyElement.textContent = `難度: ${getDifficultyText(currentDifficulty)}`;
            
            // 開始遊戲循環
            gameTime = Date.now();
            if (gameLoopId) clearInterval(gameLoopId);
            gameLoopId = setInterval(gameLoop, 16); // ~60fps
            
            statusText = '遊戲進行中！跟隨節奏按下箭頭！';
        }
        
        // 遊戲主循環
        function gameLoop() {
            if (!gameActive || gamePaused) return;
            
            updateArrows();
        }
        
        // 暫停/繼續遊戲
        function togglePause() {
            if (!gameActive || gameOver) return;
            
            gamePaused = !gamePaused;
            
            if (gamePaused) {
                pauseBtn.textContent = '繼續';
                statusText = '遊戲已暫停';
            } else {
                pauseBtn.textContent = '暫停';
                statusText = '遊戲繼續';
            }
        }
        
        // 結束遊戲
        function endGame() {
            gameActive = false;
            gameOver = true;
            
            clearInterval(gameLoopId);
            
            // 更新最高分
            if (score > highScore) {
                highScore = score;
                highScoreElement.textContent = highScore;
                localStorage.setItem('ddrHighScore', highScore);
                
                judgmentDisplay.textContent = '新紀錄！';
                judgmentDisplay.className = 'judgment-display perfect';
                judgmentDisplay.style.opacity = '1';
            } else {
                judgmentDisplay.textContent = '遊戲結束！';
                judgmentDisplay.className = 'judgment-display';
                judgmentDisplay.style.opacity = '1';
            }
            
            pauseBtn.disabled = true;
            
            // 顯示最終結果
            setTimeout(() => {
                alert(`遊戲結束！\n最終分數: ${score}\n最高連擊: ${maxCombo}\n準確率: ${accuracy}%\n\n點擊"重新開始"再次挑戰！`);
            }, 1000);
        }
        
        // 重置遊戲狀態
        function resetGameState() {
            // 清除所有箭頭
            activeNotes.forEach(note => {
                if (note.element.parentNode) {
                    note.element.parentNode.removeChild(note.element);
                }
            });
            
            activeNotes = [];
            songPattern = [];
            
            // 重置遊戲數據
            score = 0;
            combo = 0;
            maxCombo = 0;
            notesHit = 0;
            notesTotal = 0;
            accuracy = 100;
            
            currentScoreElement.textContent = score;
            comboCountElement.textContent = combo;
            accuracyElement.textContent = `${accuracy}%`;
            songProgressElement.style.width = '0%';
            
            judgmentDisplay.style.opacity = '0';
            comboDisplay.style.opacity = '0';
        }
        
        // 重置遊戲
        function resetGame() {
            clearInterval(gameLoopId);
            
            resetGameState();
            
            gameActive = false;
            gamePaused = false;
            gameOver = false;
            
            startBtn.textContent = '開始遊戲';
            pauseBtn.disabled = true;
            pauseBtn.textContent = '暫停';
            
            currentSongTitleElement.textContent = '選擇歌曲開始遊戲';
            currentDifficultyElement.textContent = '難度: 未選擇';
            
            judgmentDisplay.textContent = '';
            comboDisplay.textContent = '';
        }
        
        // 獲取難度文字
        function getDifficultyText(difficulty) {
            switch(difficulty) {
                case 'easy': return '簡單';
                case 'normal': return '普通';
                case 'hard': return '困難';
                case 'expert': return '專家';
                default: return difficulty;
            }
        }
        
        // 事件監聽器
        startBtn.addEventListener('click', startGame);
        
        pauseBtn.addEventListener('click', togglePause);
        
        restartBtn.addEventListener('click', resetGame);
        
        // 歌曲選擇
        songButtons.forEach(button => {
            button.addEventListener('click', () => {
                // 更新按鈕狀態
                songButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // 更新歌曲
                currentSong = button.getAttribute('data-song');
                
                // 如果遊戲未進行中，更新顯示
                if (!gameActive) {
                    currentSongTitleElement.textContent = SONGS[currentSong].title;
                }
            });
        });
        
        // 難度選擇
        difficultyButtons.forEach(button => {
            button.addEventListener('click', () => {
                // 更新按鈕狀態
                difficultyButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // 更新難度
                currentDifficulty = button.getAttribute('data-difficulty');
                
                // 如果遊戲未進行中，更新顯示
                if (!gameActive) {
                    currentDifficultyElement.textContent = `難度: ${getDifficultyText(currentDifficulty)}`;
                }
            });
        });
        
        // 箭頭按鈕控制
        arrowButtons.forEach(button => {
            button.addEventListener('mousedown', () => {
                const direction = button.getAttribute('data-direction');
                const lane = ARROW_TYPES.findIndex(type => type.direction === direction);
                
                button.classList.add('active');
                hitArrow(lane);
                
                // 按鈕反饋效果
                setTimeout(() => {
                    button.classList.remove('active');
                }, 100);
            });
            
            button.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const direction = button.getAttribute('data-direction');
                const lane = ARROW_TYPES.findIndex(type => type.direction === direction);
                
                button.classList.add('active');
                hitArrow(lane);
                
                // 按鈕反饋效果
                setTimeout(() => {
                    button.classList.remove('active');
                }, 100);
            });
        });
        
        // 鍵盤控制
        document.addEventListener('keydown', (e) => {
            if (!gameActive) return;
            
            // 防止默認行為
            if ([37, 38, 39, 40, 65, 83, 87, 68].includes(e.keyCode)) {
                e.preventDefault();
            }
            
            let lane = -1;
            
            // 判斷按下的鍵對應的箭頭
            switch(e.key) {
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    lane = 0;
                    document.querySelector('.left-btn').classList.add('active');
                    break;
                    
                case 'ArrowDown':
                case 's':
                case 'S':
                    lane = 1;
                    document.querySelector('.down-btn').classList.add('active');
                    break;
                    
                case 'ArrowUp':
                case 'w':
                case 'W':
                    lane = 2;
                    document.querySelector('.up-btn').classList.add('active');
                    break;
                    
                case 'ArrowRight':
                case 'd':
                case 'D':
                    lane = 3;
                    document.querySelector('.right-btn').classList.add('active');
                    break;
                    
                case ' ':
                    togglePause();
                    break;
                    
                case 'Escape':
                    resetGame();
                    break;
            }
            
            if (lane !== -1) {
                hitArrow(lane);
            }
        });
        
        document.addEventListener('keyup', (e) => {
            switch(e.key) {
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    document.querySelector('.left-btn').classList.remove('active');
                    break;
                    
                case 'ArrowDown':
                case 's':
                case 'S':
                    document.querySelector('.down-btn').classList.remove('active');
                    break;
                    
                case 'ArrowUp':
                case 'w':
                case 'W':
                    document.querySelector('.up-btn').classList.remove('active');
                    break;
                    
                case 'ArrowRight':
                case 'd':
                case 'D':
                    document.querySelector('.right-btn').classList.remove('active');
                    break;
            }
        });
        
        // 初始化遊戲
        function initGame() {
            // 設置舞台大小
            function resizeStage() {
                const container = document.querySelector('.dance-stage');
                const width = container.clientWidth;
                const height = Math.min(width * 0.7, 500);
                
                danceStage.style.height = `${height}px`;
                
                // 更新擊打線位置
                const hitLine = document.querySelector('.hit-line');
                if (hitLine) {
                    hitLine.style.bottom = `${height * 0.2}px`;
                }
            }
            
            // 初始調整大小
            resizeStage();
            
            // 監聽窗口大小變化
            window.addEventListener('resize', resizeStage);
            
            // 初始化遊戲
            resetGame();
        }
        
        // 初始化遊戲
        initGame();
    </script>
</body>
</html>